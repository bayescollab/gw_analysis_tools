<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Running with Singularity &mdash; GW Analysis Tools  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=eafc0fe6" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API" href="../api/index.html" />
    <link rel="prev" title="Running with docker: two minimal working examples" href="minimalWorkingExampleIMRPhenomD.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            GW Analysis Tools
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Welcome to GW Analysis Tools’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="contributing.html">Contributing to the documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="contributing.html#contributing-to-the-project">Contributing to the project</a></li>
<li class="toctree-l2"><a class="reference internal" href="customDockerImage.html">Writing Custom Docker Images: Example Workflows</a></li>
<li class="toctree-l2"><a class="reference internal" href="jupyterDocker.html">Dockerfiles with Jupyter</a></li>
<li class="toctree-l2"><a class="reference internal" href="minimalWorkingExampleIMRPhenomD.html">Running with docker: two minimal working examples</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Running with Singularity</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#via-docker">via Docker</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#run-the-pre-packaged-executables">Run the pre-packaged executables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#compile-custom-software-linked-to-the-compiled-libraries">Compile custom software linked to the compiled libraries</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#via-docker-and-singularity-sandbox">via Docker and Singularity Sandbox</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">GW Analysis Tools</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Tutorials</a></li>
      <li class="breadcrumb-item active">Running with Singularity</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials/singularity.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="running-with-singularity">
<h1>Running with Singularity<a class="headerlink" href="#running-with-singularity" title="Link to this heading"></a></h1>
<p>There are a few ways to run this code through a singularity container (which are much more common on scientific HPC clusters than Docker), and below is outlined an example workflow one might use (but definitely not the only way one can accomplish this).
This example will be done in the context of running on a cluster implementing SLURM, but that can be easily modified to suit the desired environment.</p>
<section id="via-docker">
<h2>via Docker<a class="headerlink" href="#via-docker" title="Link to this heading"></a></h2>
<p>The method built around Docker will utilize the maintained images on DockerHub (e.g. scottperkins/gwat and scottperkins/gw.base.deps primarily).
If one creates one’s own <a class="reference internal" href="customDockerImage.html#custom-docker-standalone"><span class="std std-ref">docker image with custom development</span></a>, simply replace all the instances of</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker://scottperkins/gwat
</pre></div>
</div>
<p>with</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker-archive://Docker-image.tgz
</pre></div>
</div>
<section id="run-the-pre-packaged-executables">
<h3>Run the pre-packaged executables<a class="headerlink" href="#run-the-pre-packaged-executables" title="Link to this heading"></a></h3>
<p>In this section, the steps to run the pre-packaged executables will be outlined.
For example, we will show how to use the “mcmc_gw_tool_v2” executable to run on pre-downloaded (and pre-processed, if applicable) data from GWOSC.
Assuming one is on the remote server, there should be all the necessary data,</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">project</span><span class="o">-</span><span class="n">dir</span>
<span class="o">|------</span><span class="n">param_file</span><span class="p">.</span><span class="n">dat</span><span class="w"> </span>
<span class="o">|------</span><span class="n">slurm_submission</span><span class="p">.</span><span class="n">sh</span>
<span class="o">|------</span><span class="n">extra_data</span><span class="p">.</span><span class="n">dat</span>
<span class="o">|------</span><span class="n">data</span><span class="o">/</span>
<span class="o">|------------</span><span class="n">PSD</span><span class="p">.</span><span class="n">dat</span>
<span class="o">|------------</span><span class="n">STRAIN</span><span class="p">.</span><span class="n">dat</span>
</pre></div>
</div>
<p>In the param_file.dat, there should be all the necessary information to run in the container (appropriate file paths, etc.).
A template can be found in “data/sample_config_files”.</p>
<p>In the slurm_submission.sh, there should be the following steps:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>

<span class="c1">#SBATCH --time=&lt;TIME&gt;</span>
<span class="c1">#SBATCH --ntasks=&lt;TASKS&gt;</span>
<span class="c1">#SBATCH --job-name=&lt;NAME&gt;</span>
<span class="c1">#SBATCH --partition=&lt;PARTITION&gt;</span>
<span class="c1">#SBATCH --output=%x-%j.output</span>
<span class="c1">#SBATCH --error=%x-%j.error</span>
<span class="c1">#SBATCH --mail-type=ALL</span>
<span class="c1">#SBATCH --mail-user=&lt;EMAIL&gt;</span>

<span class="nb">export</span><span class="w"> </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="nv">$SLURM_CPUS_PER_TASK</span>

module<span class="w"> </span>load<span class="w"> </span>singularity
<span class="nb">cd</span><span class="w"> </span>/scratch/users/<span class="nv">$USER</span><span class="w">                         </span><span class="c1"># go to scratch directory (WILL change for each user)</span>
mkdir<span class="w"> </span>-p<span class="w"> </span><span class="nv">$SLURM_JOB_NAME</span>/<span class="nv">$SLURM_JOB_ID</span><span class="w">                </span><span class="c1"># create job unique directory</span>
<span class="nb">cd</span><span class="w"> </span><span class="nv">$SLURM_JOB_NAME</span>/<span class="nv">$SLURM_JOB_ID</span><span class="w">                     </span><span class="c1"># switch to it</span>
mkdir<span class="w"> </span>data


<span class="c1"># Copy in the data</span>
cp<span class="w"> </span><span class="nv">$HOME</span>/path/to/project-dir/data/*<span class="w"> </span>./data/
cp<span class="w"> </span><span class="nv">$HOME</span>/path/to/project-dir/param_file.dat<span class="w"> </span>./
cp<span class="w"> </span><span class="nv">$HOME</span>/path/to/project-dir/extra_data.dat<span class="w"> </span>./
<span class="nb">export</span><span class="w"> </span><span class="nv">SINGULARITY_CACHEDIR</span><span class="o">=</span><span class="nv">$HOME</span>/scratch/.singularity/<span class="w"> </span><span class="c1"># Some people may need to put the cache in a specific place, as home directories don&#39;t always have enough space</span>


<span class="c1"># Launch the command. Note the bind option to mount the current directory (scratch project folder) to the container. The &quot;pwd&quot; option tells the container to run the following command from that directory in the container.</span>
singularity<span class="w"> </span><span class="nb">exec</span><span class="w">  </span>--bind<span class="w"> </span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>:/opt/project<span class="w"> </span>--pwd<span class="w"> </span>/opt/project<span class="w"> </span>docker://scottperkins/mcmc_dev<span class="w"> </span>mcmc_gw_tool_v2<span class="w"> </span>param_file.dat
</pre></div>
</div>
</section>
<section id="compile-custom-software-linked-to-the-compiled-libraries">
<h3>Compile custom software linked to the compiled libraries<a class="headerlink" href="#compile-custom-software-linked-to-the-compiled-libraries" title="Link to this heading"></a></h3>
<p>If one wants to run custom code <em>linked</em> to the pre-compiled (or custom, self-compiled) libraries, one can follow the following steps.
Working in the following directory structure</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">project</span><span class="o">-</span><span class="n">dir</span>
<span class="o">|------</span><span class="n">source</span><span class="o">-</span><span class="n">file</span><span class="p">.</span><span class="n">cpp</span><span class="w"> </span>
<span class="o">|------</span><span class="n">runscript</span><span class="p">.</span><span class="n">cpp</span><span class="w"> </span>
<span class="o">|------</span><span class="n">makefile</span>
<span class="o">|------</span><span class="n">slurm_submission</span><span class="p">.</span><span class="n">sh</span>
<span class="o">|------</span><span class="n">extra_data</span><span class="p">.</span><span class="n">dat</span>
</pre></div>
</div>
<p>The source-file.cpp file has the custom software that will link to the existing libraries.
The file runscript.sh has the commands to compile and run the software, for example</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

make<span class="w"> </span>
./source-file.exe
</pre></div>
</div>
<p>The “make” utilities are a common configuration/compilation tool, but this could be anything from manually compiling to “cmake”.
In the slurm_submission.sh, there should be the following information:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>

<span class="c1">#SBATCH --time=&lt;TIME&gt;</span>
<span class="c1">#SBATCH --ntasks=&lt;TASKS&gt;</span>
<span class="c1">#SBATCH --job-name=&lt;NAME&gt;</span>
<span class="c1">#SBATCH --partition=&lt;PARTITION&gt;</span>
<span class="c1">#SBATCH --output=%x-%j.output</span>
<span class="c1">#SBATCH --error=%x-%j.error</span>
<span class="c1">#SBATCH --mail-type=ALL</span>
<span class="c1">#SBATCH --mail-user=&lt;EMAIL&gt;</span>

<span class="nb">export</span><span class="w"> </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="nv">$SLURM_CPUS_PER_TASK</span>

module<span class="w"> </span>load<span class="w"> </span>singularity
<span class="nb">cd</span><span class="w"> </span>/scratch/users/<span class="nv">$USER</span><span class="w">                         </span><span class="c1"># go to scratch directory (WILL change for each user)</span>
mkdir<span class="w"> </span>-p<span class="w"> </span><span class="nv">$SLURM_JOB_NAME</span>/<span class="nv">$SLURM_JOB_ID</span><span class="w">                </span><span class="c1"># create job unique directory</span>
<span class="nb">cd</span><span class="w"> </span><span class="nv">$SLURM_JOB_NAME</span>/<span class="nv">$SLURM_JOB_ID</span><span class="w">                     </span><span class="c1"># switch to it</span>
mkdir<span class="w"> </span>data


<span class="c1"># Copy in the data</span>
cp<span class="w"> </span><span class="nv">$HOME</span>/path/to/project-dir/runscript.sh<span class="w"> </span>./
cp<span class="w"> </span><span class="nv">$HOME</span>/path/to/project-dir/source-file.cpp<span class="w"> </span>./
cp<span class="w"> </span><span class="nv">$HOME</span>/path/to/project-dir/makefile<span class="w"> </span>./
cp<span class="w"> </span><span class="nv">$HOME</span>/path/to/project-dir/extra_data.dat<span class="w"> </span>./
<span class="nb">export</span><span class="w"> </span><span class="nv">SINGULARITY_CACHEDIR</span><span class="o">=</span><span class="nv">$HOME</span>/scratch/.singularity/<span class="w"> </span><span class="c1"># Some people may need to put the cache in a specific place, as home directories don&#39;t always have enough space</span>


<span class="c1"># Launch the command. Note the bind option to mount the current directory (scratch project folder) to the container. The &quot;pwd&quot; option tells the container to run the following command from that directory in the container.</span>
singularity<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>--no-home<span class="w">  </span>--bind<span class="w"> </span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>:/opt/project<span class="w"> </span>--pwd<span class="w"> </span>/opt/project<span class="w"> </span>docker://scottperkins/mcmc_dev<span class="w"> </span>/bin/bash<span class="w"> </span>./runscript.sh<span class="w"> </span>
</pre></div>
</div>
<p>Note, the option “–no-home” stops singularity from binding the user’s home directory in the container. This is <em>optional</em>, but if the user is experiencing problems with multiple installations of software, this helps isolate the container from the host system (hopefully resolving these issues).</p>
</section>
</section>
<section id="via-docker-and-singularity-sandbox">
<h2>via Docker and Singularity Sandbox<a class="headerlink" href="#via-docker-and-singularity-sandbox" title="Link to this heading"></a></h2>
<p>TBD</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="minimalWorkingExampleIMRPhenomD.html" class="btn btn-neutral float-left" title="Running with docker: two minimal working examples" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../api/index.html" class="btn btn-neutral float-right" title="API" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Scott Ellis Perkins.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>